<html>

  <head>
    <style>
      body{ margin: 0px;  background:#000;}
      html{ overflow: hidden }
      h1{
        color:#111;
        position:absolute;
        width:100%;
        bottom:20%;
        text-align: center;
        font-family: "Trebuchet MS", Helvetica, sans-serif;
      }
      h1:hover{

        text-decoration: underline;
        color:#666;
      }
    </style>
  </head>

  <body>
 
    <script src = "lib/three.min.js"                ></script>
    <script src = "lib/jquery.min.js"               ></script>
    <script src = "lib/ShaderLoader.js"             ></script>
    <script src = "lib/stats.min.js"                ></script>

    <script src = "lib/TrackballControls.js"        ></script>
    <script src = "lib/MouseMoveControls.js"        ></script>
    <script src = "lib/ObjectControls.js"           ></script>
    

    <script src = "lib/Link.js"           ></script>
    <script src = "tween.min.js"           ></script>




    <script>

    var frameSlow = 6;
    var counter = 0;

    var moving = false;


    var holos = [];

      var camera, renderer, scene , controls , clock;
      
      var audioMesh;

      // Setting up shaders
      var shaders = new ShaderLoader( 'shaders' );

      shaders.shaderSetLoaded = function(){
        init();
        animate();
      }

      shaders.load( 'vs-holo' , 'holo' , 'vertex'   );
      //shaders.load( 'fs-holo' , 'holo' , 'fragment' );
      shaders.load( 'fs-map1' , 'holo' , 'fragment' );
      shaders.load( 'fs-tree' , 'tree' , 'fragment' );
      shaders.load( 'fs-bg' , 'bg' , 'fragment' );


      // Normals For the Material
      var uniforms = {

        dT:       { type:"f"  , value : 0             },
        time:     { type:"f"  , value : 0             },
        

        lightPosition1: { type:"v3" , value : new THREE.Vector3() },
        lightPosition2: { type:"v3" , value : new THREE.Vector3() },
        lightColor1   : { type:"v3" , value : new THREE.Vector3() },
        lightColor2   : { type:"v3" , value : new THREE.Vector3() },
       


        parameter1: { type:"f"  , value : .5             },
        parameter2: { type:"f"  , value : .5             },
        parameter3: { type:"f"  , value : .5             },
        parameter4: { type:"f"  , value : .5             },
        parameter5: { type:"f"  , value : .5             },
        parameter6: { type:"f"  , value : .5             },

        filledness :{ type:"f" , value: 0 },
        completed  :{ type:"f" , value: 0 },

      }


      function init(){

        //textCreator = new TextCreator( 3 );


        /*


           Setting up THREE.js Scene


        */

        var w = window.innerWidth;
        var h = window.innerHeight;

        camera = new THREE.PerspectiveCamera( 65 , w/h , .1 , 30 );
        camera.position.z = .5;
        //camera.position.x = 3.5;

        scene = new THREE.Scene();

        var dpr = window.devicePixelRatio || 1;
        renderer = new THREE.WebGLRenderer();
        renderer.setPixelRatio( dpr );
        renderer.setSize( window.innerWidth, window.innerHeight );

        document.body.appendChild( renderer.domElement );


        stats = new Stats();
        stats.domElement.style.position = "absolute";
        stats.domElement.style.left = "0px";
        stats.domElement.style.bottom = "-30px";
        stats.domElement.style.zIndex = "999";
        document.body.appendChild( stats.domElement );

        window.addEventListener( 'resize', onWindowResize, false );
        window.addEventListener( 'keydown', keydown, false );

        clock = new THREE.Clock();


        //controls = new THREE.MouseMoveControls( camera );
        controls = new THREE.TrackballControls( camera );

        objectControls = new ObjectControls( camera );


        var position = new THREE.Vector3( 4 , 2 , .8 );
        var lightColor = new THREE.Vector3( 1 , 0 , 0 );
        uniforms.lightPosition1.value.copy( position );

        var geo = new THREE.IcosahedronGeometry( .1 , 1 );
        var mat = new THREE.MeshBasicMaterial({color:0xff0000})
        light1 = new THREE.Mesh( geo , mat );
        scene.add( light1 )
 


        var position = new THREE.Vector3( -3 , 1.5 , 2.8 );
        uniforms.lightPosition2.value.copy( position );

        var geo = new THREE.IcosahedronGeometry( .1 , 1 );
        var mat = new THREE.MeshBasicMaterial({color:0x0000ff})

        light2 = new THREE.Mesh( geo , mat )
        scene.add( light2 );




        var geo = new THREE.BoxGeometry( 3,3,3 )

        BG = new THREE.Mesh( geo , new THREE.ShaderMaterial({
          uniforms: {

            time:          uniforms.time,
            lightPosition1: uniforms.lightPosition1,
            lightPosition2: uniforms.lightPosition2,

            filledness : uniforms.filledness,
            completed : uniforms.completed,

            parameter1: { type:"f"  , value : .5 },
            parameter2: { type:"f"  , value : .5 },
            parameter3: { type:"f"  , value : .5 },
            parameter4: { type:"f"  , value : .5 },
            parameter5: { type:"f"  , value : .5 },
            parameter6: { type:"f"  , value : .5 },

            iModelMat:{ type:"m4" , value: new THREE.Matrix4() },
            lightColor1: uniforms.lightColor1,
            lightColor2: uniforms.lightColor2,

          },
          vertexShader: shaders.vs.holo,
          fragmentShader: shaders.fs.bg,
          side: THREE.BackSide

        }))

        //scene.add( BG )


 

        var geo = new THREE.BoxGeometry( 1. , 1. , 1. )

       for( var i = 0; i< 16; i++ ){

        var holo = new THREE.Mesh( geo , new THREE.ShaderMaterial({
          uniforms: {

            time:          uniforms.time,
            lightPosition1: uniforms.lightPosition1,
            lightPosition2: uniforms.lightPosition2,

            filledness : uniforms.filledness,
            completed : uniforms.completed,

            parameter1: { type:"f"  , value : .5 },
            parameter2: { type:"f"  , value : .5 },
            parameter3: { type:"f"  , value : .5 },
            parameter4: { type:"f"  , value : .5 },
            parameter5: { type:"f"  , value : .5 },
            parameter6: { type:"f"  , value : .5 },

            iModelMat:{ type:"m4" , value: new THREE.Matrix4() },
            lightColor1: uniforms.lightColor1,
            lightColor2: uniforms.lightColor2,

          },
          vertexShader: shaders.vs.holo,
          fragmentShader: shaders.fs.holo,
         // side: THREE.BackSide

        }))

        scene.add( holo )

        holos.push( holo )


       }




      }

      function mainClick(){

        console.log( 'HEY' ); 

        var color1 = new THREE.Vector3( Math.random() , Math.random() , Math.random() );
        var color2 = new THREE.Vector3( Math.random() , Math.random() , Math.random() );

        uniforms.lightColor1.value.copy( color1 );
        uniforms.lightColor2.value.copy( color2 );

        //tweet.updateColor( color1 );
        //email.updateColor( color2 );

      }
      
      function animate(){

        requestAnimationFrame( animate );
        TWEEN.update();

        counter ++;

        //if( counter == frameSlow ){
          counter = 0;
          renderer.render( scene , camera );
        //}
       
        stats.update();
        uniforms.dT.value = clock.getDelta();
        uniforms.time.value += uniforms.dT.value;

        uniforms.lightPosition1.value.x = 1 * Math.cos( uniforms.time.value * .4 + Math.PI * 0 );
        uniforms.lightPosition1.value.z = 1 * Math.sin( uniforms.time.value * .1 + Math.PI * 0 );
        uniforms.lightPosition1.value.y = 1 * Math.sin( uniforms.time.value * .3 + Math.PI * 0 );
       


        uniforms.lightPosition2.value.x = 1 * Math.cos( uniforms.time.value * .4 + Math.PI * 1 );
        uniforms.lightPosition2.value.z = 1 * Math.sin( uniforms.time.value * .5 + Math.PI * 1 );
        uniforms.lightPosition2.value.y = 1 * Math.sin( uniforms.time.value * .2 + Math.PI * 1 );

        light1.position.copy( uniforms.lightPosition1.value )
        light2.position.copy( uniforms.lightPosition2.value )



        for( var i = 0; i< holos.length; i++ ){

          holos[i].position.x = Math.sin( uniforms.time.value * ( i + 4 ) * .01 ) * 3. * Math.sin( uniforms.time.value  * .01 * (i+2));
          holos[i].position.y = Math.sin( uniforms.time.value * ( i + 4 ) * .0173 ) * 3.* Math.sin( uniforms.time.value  * .01 * (i+2));
          holos[i].position.z = Math.sin( uniforms.time.value * ( i + 4 ) * .0074 ) * 3.* Math.sin( uniforms.time.value  * .01 * (i+2));

          holos[i].rotation.x += .01 * Math.sin( i + 1 ); 
          holos[i].rotation.y += .01 * Math.sin( i + 1 ); 
          holos[i].rotation.z += .01 * Math.sin( i + 1 ); 
        
          holos[i].updateMatrixWorld();
          holos[i].material.uniforms.iModelMat.value.getInverse( holos[i].matrixWorld );
          
          holos[i].material.uniforms.parameter1.value = holos[i].position.x;
          holos[i].material.uniforms.parameter2.value = holos[i].position.y;
          holos[i].material.uniforms.parameter3.value = holos[i].position.z;

          holos[i].material.uniforms.parameter4.value = holos[i].rotation.x;
          holos[i].material.uniforms.parameter5.value = holos[i].rotation.y;
          holos[i].material.uniforms.parameter6.value = holos[i].rotation.z;

        }

        controls.update();
        objectControls.update();


      }

      function keydown( e ) {
        //console.log( e )
        if( e.keyCode == 82 )
          renderer.render( scene , camera );

        console.log( e.keyCode )

        if( e.keyCode == 49 ){ uniforms.parameter1.value  += .1 }
        if( e.keyCode == 81 ){ uniforms.parameter1.value  -= .1 }

        if( e.keyCode == 50 ){ uniforms.parameter2.value  += .1 }
        if( e.keyCode == 87 ){ uniforms.parameter2.value  -= .1 }

        if( e.keyCode == 51 ){ uniforms.parameter3.value  += .1 }
        if( e.keyCode == 69 ){ uniforms.parameter3.value  -= .1 }

        if( e.keyCode == 52 ){ uniforms.parameter4.value  += .1 }
        if( e.keyCode == 82 ){ uniforms.parameter4.value  -= .1 }

        if( e.keyCode == 53 ){ uniforms.parameter5.value  += .1 }
        if( e.keyCode == 84 ){ uniforms.parameter5.value  -= .1 }

        if( e.keyCode == 54 ){ uniforms.parameter6.value  += .1 }
        if( e.keyCode == 89 ){ uniforms.parameter6.value  -= .1 }

        if( e.keyCode == 32 ){ 

          var addVal = 1/6;

          if( uniforms.completed.value > .5 ){
            addVal = -addVal;
          }

          new TWEEN.Tween( uniforms.filledness )
            .to( { value: uniforms.filledness.value + addVal }, 1000 )
            .easing( TWEEN.Easing.Exponential.InOut )
            .start();

          if( uniforms.filledness.value + 1 / 6 >= 1 ){
            new TWEEN.Tween( uniforms.completed )
              .to( { value: 1 }, 4000 )
              .easing( TWEEN.Easing.Exponential.InOut )
              .start();
          }

        }

      }

      function toggleMovement(){

        moving = !moving;

      }


      function onWindowResize() {

				camera.aspect = window.innerWidth / window.innerHeight;
				camera.updateProjectionMatrix();

				renderer.setSize( window.innerWidth, window.innerHeight );

			}

      function tweenUp(){


      }


      function createTextMesh( size  ,  text ){
    
        var canvas  = document.createElement('canvas');


        var fullSize = 30000;
        var margin = 40;

        var ctx     = canvas.getContext( '2d' ); 


        ctx.font      = fullSize / 100 + "pt GeoSans";
        var textWidth = ctx.measureText( text ).width;

        canvas.width  = textWidth + margin;
        canvas.height = fullSize / 100 + margin;

       
        // Creates a texture
        var texture = new THREE.Texture(canvas);


        updateTextTexture( text , canvas , ctx , texture , textWidth )


        var mesh = new THREE.Mesh( 
          new THREE.PlaneBufferGeometry( 1 , 1 ), 
          new THREE.MeshBasicMaterial({ 
            map: texture,
            transparent: true,
            blending: THREE.AdditiveBlending,
            depthWrite: false

          })
        );

        mesh.scale.y = canvas.height;
        mesh.scale.x = canvas.width;
        mesh.scale.multiplyScalar( .1  * (size / 100));

        mesh.texture = texture;
        mesh.canvas = canvas;
        mesh.ctx = ctx;
        mesh.textWidth = textWidth;

        return mesh;


      }

      function updateTextTexture( string , canvas , ctx , texture , textWidth ){

        var fullSize = 30000;
        var margin = 1000000;

        ctx.fillStyle = "rgba(0,0,0,1)";
        ctx.fillRect(
            canvas.width / 2 - textWidth / 2 - margin / 2, 
            canvas.height / 2 - fullSize / 2  + margin / 2, 
            textWidth + margin, 
            fullSize + margin
        );

        // Makes sure our text is centered
        ctx.textAlign = "center";
        ctx.textBaseline = "middle";
        ctx.fillStyle = "#ffffff";
        ctx.font      = fullSize / 150 + "pt Trebuchet MS";
        ctx.fillText( string , canvas.width / 2, canvas.height / 2);


        texture.needsUpdate = true;


      }



    </script>

  </body>
</html>
